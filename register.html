<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sign-Up â€“ YGJ</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* === Kleine optische Verfeinerungen fÃ¼r das Register-Form === */
    .intro {
      text-align: center;
      margin-top: 60px;
    }

    .intro input {
      display: block;
      margin: 10px auto;
      padding: 10px;
      width: 80%;
      max-width: 300px;
      border-radius: 8px;
      border: 1px solid #ccc;
      transition: border-color 0.3s ease;
    }

    .intro input:focus {
      outline: none;
      border-color: #e0c280;
    }

    #register-message {
      font-weight: bold;
      margin-top: 12px;
      transition: opacity 0.3s ease;
      min-height: 22px;
    }

    .error-flash {
      animation: flashRed 0.5s ease;
    }

    @keyframes flashRed {
      from { color: #000; }
      to { color: #f00; }
    }

    .btn[disabled] {
      opacity: 0.7;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <header>
    <a href="index.html" class="home-btn">
      <img src="https://uxwing.com/wp-content/themes/uxwing/download/web-app-development/home-page-white-icon.png" alt="Home">
    </a>
    <h1>Youth Growing Journey</h1>
    <button class="btn login-header-btn" onclick="window.location.href='login.html'">
      <i class="fa-solid fa-right-to-bracket"></i> Log In
    </button>
    <button class="btn" onclick="window.location.href='register.html'">
      <i class="fa-solid fa-user-plus"></i> Sign Up
    </button>
    <button id="theme-toggle" class="theme-btn" aria-label="Switch theme" style="margin-right: 10px; padding: 10px 12px 12px 12px;">ðŸŒ™</button>
    <button id="menu-toggle" class="menu-btn">&#9776;</button>
  </header>

  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <button id="close-sidebar" class="close-btn">&times;</button>
    </div>
    <div class="sidebar-content">
      <button onclick="window.location.href='profile.html'">
        <i class="fa-solid fa-user"></i> Profile
      </button>
      <button onclick="window.location.href='about-us.html'">
        <i class="fa-solid fa-info-circle"></i> About Us
      </button>
      <button onclick="window.location.href='contact.html'">
        <i class="fa-solid fa-envelope"></i> Contact Us
      </button>
    </div>
  </div>

  <section class="intro" aria-labelledby="register-heading">
    <h2 id="register-heading">Create Account</h2>

    <label for="new-username" style="display:block; font-weight:600;">Username</label>
    <input type="text" id="new-username" placeholder="Username" class="login-input" aria-label="Username" autocomplete="username">

    <div>
      <label for="new-email" style="display:block; font-weight:600; margin-top:6px;">Email:</label>
      <input type="email" id="new-email" placeholder="Enter email" aria-label="Email" autocomplete="email" />
    </div>

    <label for="new-password" style="display:block; font-weight:600; margin-top:6px;">Password</label>
    <input type="password" id="new-password" placeholder="Password (min. 8 characters)" class="login-input" minlength="8" aria-label="Password" autocomplete="new-password">
    
    <div style="margin-top:12px;">
      <button class="btn" id="register-submit"><i class="fa-solid fa-user-plus"></i> Confirm</button>
    </div>

    <p id="register-message" role="status" aria-live="polite" aria-atomic="true"></p>
  </section>

  <footer>
    &copy; Youth Growing Journey â€“ built for a strong generation.
  </footer>

  <script src="script.js"></script>
  <script>
    (function() {
      // CONFIG
      const API_BASE = 'http://localhost:5000/api'; // <-- in production: replace with your real API URL
      const TOKEN_KEY = 'ygj_token';
      const USER_KEY = 'ygj_user';

      // Helpers
      function showMessage(el, text, color = 'red', flash = false) {
        if (!el) return;
        el.textContent = text;
        el.style.color = color;
        if (flash) {
          el.classList.remove('error-flash');
          // trigger reflow to restart animation
          void el.offsetWidth;
          el.classList.add('error-flash');
        } else {
          el.classList.remove('error-flash');
        }
      }

      function isValidEmail(e) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);
      }

      function saveAuth(token, user) {
        try {
          localStorage.setItem(TOKEN_KEY, token);
          localStorage.setItem(USER_KEY, JSON.stringify(user));
        } catch (e) {
          console.warn('Could not save auth to storage', e);
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        const usernameInput = document.getElementById('new-username');
        const emailInput = document.getElementById('new-email');
        const passwordInput = document.getElementById('new-password');
        const registerBtn = document.getElementById('register-submit');
        const messageEl = document.getElementById('register-message');

        if (!registerBtn) return;

        // avoid double-binding
        if (registerBtn.dataset.bound === '1') return;
        registerBtn.dataset.bound = '1';

        // Set focus on first field
        usernameInput.focus();

        registerBtn.addEventListener('click', async (ev) => {
          ev.preventDefault();

          // reset styles/messages
          usernameInput.style.borderColor = '';
          emailInput.style.borderColor = '';
          passwordInput.style.borderColor = '';
          showMessage(messageEl, '', 'red', false);

          const username = usernameInput.value.trim();
          const email = emailInput.value.trim();
          const password = passwordInput.value;

          // Client-side validation
          if (!username || !email || !password) {
            if (!username) usernameInput.style.borderColor = 'red';
            if (!email) emailInput.style.borderColor = 'red';
            if (!password) passwordInput.style.borderColor = 'red';
            showMessage(messageEl, 'Please fill out all fields!', 'red', true);
            return;
          }

          if (!isValidEmail(email)) {
            emailInput.style.borderColor = 'red';
            showMessage(messageEl, 'Please enter a valid email address!', 'red', true);
            emailInput.focus();
            return;
          }

          if (password.length < 8) {
            passwordInput.style.borderColor = 'red';
            showMessage(messageEl, 'Password must be at least 8 characters!', 'red', true);
            passwordInput.focus();
            return;
          }

          // Disable button to prevent duplicate submissions
          registerBtn.disabled = true;
          registerBtn.setAttribute('aria-busy', 'true');
          const originalBtnText = registerBtn.innerHTML;
          registerBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Creating...';

          try {
            const payload = {
              displayName: username,
              email,
              password
            };

            const res = await fetch(`${API_BASE}/auth/register`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            // parse JSON safely
            const data = await res.json().catch(() => ({}));

            if (!res.ok) {
              // backend provided message?
              const err = data && data.message ? data.message : `Registration failed (status ${res.status})`;
              // if conflict (email exists) map message to fields
              if (res.status === 400 && /email/i.test(err)) {
                emailInput.style.borderColor = 'red';
              }
              if (res.status === 400 && /displayName|username/i.test(err)) {
                usernameInput.style.borderColor = 'red';
              }
              showMessage(messageEl, err, 'red', true);
              return;
            }

            // Success: expect token + user
            if (data && data.token && data.user) {
              // save token + user
              saveAuth(data.token, data.user);

              showMessage(messageEl, 'âœ… Registration successful â€” logged in!', 'limegreen', false);

              // small delay for UX then redirect to profile
              setTimeout(() => {
                window.location.href = 'profile.html';
              }, 800);
            } else {
              // Unexpected response shape
              showMessage(messageEl, 'Registration succeeded but server returned unexpected response.', 'red', true);
              console.warn('Unexpected register response:', data);
            }
          } catch (err) {
            console.error('Registration request failed', err);
            showMessage(messageEl, 'Network or server error. Try again later.', 'red', true);
          } finally {
            // Re-enable button
            registerBtn.disabled = false;
            registerBtn.removeAttribute('aria-busy');
            registerBtn.innerHTML = originalBtnText;
          }
        });
      });
    })();
  </script>
</body>
</html>
